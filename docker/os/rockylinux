#------------------------------------------------------------------------------#
# FleCSI CI Configuration for CentOS 8
#------------------------------------------------------------------------------#

FROM rockylinux/rockylinux:latest

#------------------------------------------------------------------------------#
# Image arguments.
#------------------------------------------------------------------------------#

ARG SPACK_REPO
ARG SPACK_BRANCH
ARG SPACK_HASH

#------------------------------------------------------------------------------#
# Install and configure Extra Packages for Enterprise Linux
#------------------------------------------------------------------------------#

RUN dnf install -y epel-release 'dnf-command(config-manager)'

RUN dnf config-manager --set-enabled powertools

#------------------------------------------------------------------------------#
# Install basic linux requirements
#------------------------------------------------------------------------------#

RUN dnf update -y && dnf install -y \
  ccache \
  clang \
  cmake \
  doxygen \
  flex \
  gcc-toolset-9 \
  git \
  lbzip2 \
  make \
  passwd \
  patch \
  python3 \
  rsync \
  sudo \
  vim-enhanced \
  wget \
  which

#------------------------------------------------------------------------------#
# Add flecsi user
#------------------------------------------------------------------------------#

RUN groupadd -r flecsi
RUN useradd -r -m -g flecsi flecsi
RUN echo "flecsi ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/flecsi

USER flecsi
WORKDIR /home/flecsi

ADD --chown=flecsi:flecsi bashrc ./.bashrc
ADD --chown=flecsi:flecsi dircolors ./.dircolors
ADD --chown=flecsi:flecsi vimrc ./.vimrc

#------------------------------------------------------------------------------#
# Setup gcc 9
#------------------------------------------------------------------------------#

ENV PATH /opt/rh/gcc-toolset-9/root/usr/bin:$PATH
RUN gcc -v 2>&1 | grep "gcc version" | awk '{ print $3 }' > .gnu_version

#------------------------------------------------------------------------------#
# Install pip packages
#------------------------------------------------------------------------------#

RUN pip3 install --user pyyaml
RUN pip3 install --user Sphinx
RUN pip3 install --user recommonmark
RUN pip3 install --user sphinx_rtd_theme

#------------------------------------------------------------------------------#
# Clone spack and create copy for the upstream install.
#------------------------------------------------------------------------------#

ARG EMPH="\e[38;5;36m"
ARG NEMPH="\e[0m"

RUN echo -e "${EMPH}Cloning spack: ${SPACK_BRANCH} at ${SPACK_HASH} from ${SPACK_REPO}${NEMPH}"
RUN git clone --single-branch --branch ${SPACK_BRANCH} ${SPACK_REPO} .spack
RUN if [[ "${SPACK_HASH}" != "HEAD" ]] ; \
      then cd .spack && git checkout -b "ci-${SPACK_HASH}" ${SPACK_HASH} ; \
    fi
RUN cp -r .spack .spack-upstream

#------------------------------------------------------------------------------#
# Set default shell for interactive
#------------------------------------------------------------------------------#

CMD /bin/bash

# vim: syntax=dockerfile
