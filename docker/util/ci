#------------------------------------------------------------------------------#
# FleCSI CI Configuration for Environment
#------------------------------------------------------------------------------#

ARG OS
FROM ${OS}

#------------------------------------------------------------------------------#
# Setup spack configuration.
#------------------------------------------------------------------------------#

ADD clang_fortran.py ./.clang_fortran.py
ADD spack ./.spack-aux

RUN . .spack/share/spack/setup-env.sh && \
  spack compiler find

RUN export GNU_VERSION=`cat .gnu_version` && \
  /home/flecsi/.clang_fortran.py '.spack/linux/compilers.yaml' \
    '.spack/etc/spack/compilers.yaml' "${GNU_VERSION}"
RUN rm -rf ~/.spack/linux/compilers.yaml

RUN export GNU_VERSION=`cat .gnu_version` && \
  cat .spack-aux/packages.yaml | \
    sed "s,GNU_VERSION,${GNU_VERSION},g" > \
    .spack/etc/spack/packages.yaml

RUN cp .spack-aux/config.yaml .spack/etc/spack

#------------------------------------------------------------------------------#
# Install generic packages
#------------------------------------------------------------------------------#

RUN . .spack/share/spack/setup-env.sh && \
  spack fetch --dependencies cmake && \
  spack install cmake

#------------------------------------------------------------------------------#
# Create format environment
#------------------------------------------------------------------------------#

RUN . .spack/share/spack/setup-env.sh && \
  spack env create format && \
  spack env activate format && \
  spack install cmake

#------------------------------------------------------------------------------#
# Set default shell for interactive
#------------------------------------------------------------------------------#

CMD /bin/bash

# vim: syntax=dockerfile
